name: Test

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  test:
    name: Test on ${{ matrix.os }} - Python ${{ matrix.python-version }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
        python-version: ['3.9', '3.10', '3.11', '3.12']
        # Windows tests are more complex due to tmux requirements
        # We'll handle Windows separately if needed

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install system dependencies (Ubuntu)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y tmux fzf
          # Install ripgrep
          curl -LO https://github.com/BurntSushi/ripgrep/releases/download/14.1.0/ripgrep_14.1.0-1_amd64.deb
          sudo dpkg -i ripgrep_14.1.0-1_amd64.deb
          # Install delta
          curl -LO https://github.com/dandavison/delta/releases/download/0.17.0/git-delta_0.17.0_amd64.deb
          sudo dpkg -i git-delta_0.17.0_amd64.deb

      - name: Install system dependencies (macOS)
        if: matrix.os == 'macos-latest'
        run: |
          brew install tmux ripgrep fzf git-delta

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install uv
        uses: astral-sh/setup-uv@v3
        with:
          enable-cache: true

      - name: Install Python dependencies
        run: |
          uv venv
          uv pip install -e .
          uv pip install pytest pytest-timeout pytest-pretty

      - name: Verify installations
        run: |
          echo "=== System info ==="
          uname -a
          echo "=== Python version ==="
          python --version
          echo "=== tmux version ==="
          tmux -V
          echo "=== ripgrep version ==="
          rg --version
          echo "=== fzf version ==="
          fzf --version
          echo "=== delta version ==="
          delta --version

      - name: Run tests
        run: |
          uv run pytest tests/test_rgi.py -v --tb=short --timeout=60
        env:
          TERM: xterm-256color
          CI: true

      - name: Run type checking with ty
        run: |
          uvx ty check
        continue-on-error: true # Don't fail the build on type errors for now

      - name: Upload test results on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-failure-${{ matrix.os }}-py${{ matrix.python-version }}
          path: |
            tests/test-fixture-*
          retention-days: 7

  # Separate job for Windows testing with WSL
  test-windows:
    name: Test on Windows with WSL (Optional)
    runs-on: windows-latest
    continue-on-error: true # Don't fail the entire workflow if Windows tests fail
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.11'] # Test with one Python version for Windows
    timeout-minutes: 20 # Reduced timeout - if it takes longer, something is wrong

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup WSL
        uses: Vampire/setup-wsl@v3
        with:
          distribution: Ubuntu-22.04
          wsl-shell-user: runner
          additional-packages: |
            tmux
            fzf
            ripgrep
            python3-pip
            python3-venv
            curl
            git

      # Skip delta installation on Windows - it's not essential for tests
      # and causes hanging issues in CI

      - name: Install minimal test dependencies in WSL
        shell: wsl-bash {0}
        timeout-minutes: 10
        run: |
          # Minimal setup for Windows - just copy scripts and install pytest
          echo "Installing pytest with system Python..."
          python3 -m pip install --user pytest pytest-timeout || { echo "Failed to install pytest"; exit 1; }

          echo "Making scripts available..."
          mkdir -p ~/.local/bin
          cp src/rgi/scripts/* ~/.local/bin/
          chmod +x ~/.local/bin/rgi*
          export PATH="$HOME/.local/bin:$PATH"

          echo "Minimal dependencies installed successfully"

      - name: Verify installations in WSL
        shell: wsl-bash {0}
        timeout-minutes: 2
        run: |
          echo "=== System info ==="
          uname -a
          echo "=== Python version ==="
          python3 --version
          echo "=== tmux version ==="
          tmux -V
          echo "=== ripgrep version ==="
          rg --version
          echo "=== fzf version ==="
          fzf --version
          echo "=== pytest installed ==="
          python3 -m pytest --version || echo "pytest not found"
          echo "=== rgi script available ==="
          export PATH="$HOME/.local/bin:$PATH"
          which rgi || echo "rgi not found"
          echo "=== Note: Delta not installed on Windows CI ==="

      - name: Run tests in WSL
        shell: wsl-bash {0}
        timeout-minutes: 10
        run: |
          export TERM=xterm-256color
          export CI=true
          export PATH="$HOME/.local/bin:$PATH"

          # Run a subset of tests for Windows with system Python
          python3 -m pytest tests/test_rgi.py::test_basic_pattern_search -v --tb=short --timeout=60 || true
          python3 -m pytest tests/test_rgi.py::test_default_command_mode -v --tb=short --timeout=60 || true

      - name: Upload test results on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-failure-windows-py${{ matrix.python-version }}
          path: |
            tests/test-fixture-*
          retention-days: 7
