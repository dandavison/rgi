#!/bin/bash

# Debug logging (disabled for now)
# echo "rgi started with args: $@" >> /tmp/rgi-debug.log

# Get absolute path to this script
SCRIPT_PATH="$(realpath "${BASH_SOURCE[0]}" 2>/dev/null || readlink -f "${BASH_SOURCE[0]}" 2>/dev/null || echo "${BASH_SOURCE[0]}")"
if [[ ! "$SCRIPT_PATH" = /* ]]; then
    SCRIPT_PATH="$(cd "$(dirname "$0")" && pwd)/$(basename "$0")"
fi

# Get directory containing this script
SCRIPT_DIR="$(dirname "$SCRIPT_PATH")"

# Add script directory to PATH so rgi-preview can be found
export PATH="$SCRIPT_DIR:$PATH"

# Parse arguments
pattern=""
paths=()
rg_opts=""
MODE="command"

# Single pass through arguments
while [[ $# -gt 0 ]]; do
    if [[ "$1" == "--rgi-command-mode" ]]; then
        MODE="command"
        shift
    elif [[ "$1" == "--rgi-pattern-mode" ]]; then
        MODE="pattern"
        shift
    elif [[ "$1" =~ ^- ]]; then
        opt="$1"
        rg_opts+=" $opt"
        shift
        case "$opt" in
            -g|--glob|-t|--type|-e|--regexp)
                [[ $# -gt 0 ]] && rg_opts+=" '$1'" && shift
                ;;
        esac
    else
        break
    fi
done

# Pattern and paths
[[ $# -gt 0 ]] && pattern="$1" && shift
while [[ $# -gt 0 ]]; do paths+=("$1"); shift; done
[[ ${#paths[@]} -eq 0 ]] && paths=(.)

# Commands
RG="rg --follow -i --hidden -g '!.git/*'$rg_opts --color=always"
DELTA="delta --light --grep-output-type classic"

# fzf wrapper
fzf() {
    command fzf --layout reverse --info hidden --prompt ' ' --color light --ansi \
        --bind ctrl-k:kill-line --bind alt-right:forward-word --bind alt-left:backward-word \
        --preview-window up,70% "$@"
}

if [[ "$MODE" == "command" ]]; then
    # Command mode - the query IS the full rg command
    full_command="rg --follow -i --hidden -g '!.git/*'$rg_opts --json $pattern ${paths[*]}"

    # Hack: to trigger display we append a space and then delete it on start
    echo "" |
    fzf -d: \
        --query="$full_command " \
        --phony \
        --bind='start:reload:'"$RG"' --json "'"$pattern"'" '"${paths[*]}"' 2>/dev/null | '"$DELTA" \
        --bind='start:backward-delete-char' \
        --bind='change:reload:eval {q} 2>/dev/null | '"$DELTA" \
        --bind='tab:execute:
            # Extract the pattern, options, and paths from the edited command
            cmd="{q}"
            # Extract everything between rg and --json as options
            OPTIONS=$(echo "$cmd" | sed -E "s/^[^ ]+ +(.*)--json.*/\1/" | sed "s/--follow -i --hidden -g '\''!.git\/\*'\''//")
            # Simple extraction - get word after --json, strip quotes and backslashes
            PATTERN=$(echo "$cmd" | sed -E "s/.*--json +([^ ]+).*/\1/;s/[\"'\''\\\\]//g")
            # Extract paths - everything after the pattern
            # First remove everything up to and including the pattern, and strip quotes
            AFTER_PATTERN=$(echo "$cmd" | sed -E "s/.*--json +[^ ]+ *//;s/^[\"'\'']//;s/[\"'\'']$//")
            if [[ -n "$AFTER_PATTERN" ]]; then
                PATHS="$AFTER_PATTERN"
            else
                PATHS="${paths[*]}"
            fi
            # Kill parent fzf and start new instance
            # echo "cmd=[$cmd] PATTERN=[$PATTERN] OPTIONS=[$OPTIONS] PATHS=[$PATHS]" >> /tmp/rgi-debug.log
            kill -TERM $PPID 2>/dev/null
            '"$SCRIPT_PATH"' $OPTIONS --rgi-pattern-mode "$PATTERN" $PATHS' \
        --bind='enter:execute:open-in-editor {1} {2}' \
        --preview="[[ -n {1} ]] && rgi-preview {1} {2}"
elif [[ "$MODE" == "pattern" ]]; then
    # Pattern mode - the query is just the search pattern
    # Use --phony with start:reload to show initial results
    # Hack: to trigger display we append a space and then delete it on start
    echo "" |
    fzf -d: \
        --query="$pattern " \
        --phony \
        --bind='start:reload:'"$RG"' --json "'"$pattern"'" '"${paths[*]}"' 2>/dev/null | '"$DELTA" \
        --bind='start:backward-delete-char' \
        --bind='change:reload:'"$RG"' --json {q} '"${paths[*]}"' 2>/dev/null | '"$DELTA" \
        --bind='tab:execute:kill -TERM $PPID 2>/dev/null; '"$SCRIPT_PATH"' '"$rg_opts"' --rgi-command-mode "{q}" '"${paths[*]}" \
        --bind='enter:execute:open-in-editor {1} {2}' \
        --header='rg --follow -i --hidden -g "!.git/*"'"$rg_opts"' --color=always {q} '"${paths[*]}" \
        --preview="[[ -n {1} ]] && rgi-preview {1} {2}"
fi
