#!/usr/bin/env python3
import os
import shlex
import subprocess
import sys
from pathlib import Path


def main():
    """Main entry point for rgi."""
    # Debug logging (disabled for now)
    # with open("/tmp/rgi-debug.log", "a") as f:
    #     f.write(f"rgi started with args: {sys.argv}\n")

    # Get absolute path to this script
    SCRIPT_PATH = str(Path(__file__).resolve())

    # Get directory containing this script
    SCRIPT_DIR = str(Path(SCRIPT_PATH).parent)

    # Add script directory to PATH so rgi-preview can be found
    os.environ["PATH"] = f"{SCRIPT_DIR}:{os.environ.get('PATH', '')}"

    # Parse command line arguments
    mode, pattern, paths, rg_opts = parse_arguments(sys.argv[1:])

    # Parse ripgrep config file
    RIPGREP_CONFIG_PATH = os.environ.get("RIPGREP_CONFIG_PATH", "")
    config_args = parse_ripgrep_config(RIPGREP_CONFIG_PATH)

    # Implicit options that are always applied but never shown
    IMPLICIT_OPTS = "--json"

    # Commands
    # Include config args explicitly (not via RIPGREP_CONFIG_PATH to avoid double application)
    config_part = f" {config_args}" if config_args else ""
    RG = f"rg{config_part}{rg_opts} {IMPLICIT_OPTS}"
    DELTA = "delta --grep-output-type classic"

    # Build fzf command based on mode
    if mode == "command":
        fzf_cmd = build_command_mode_fzf(
            pattern,
            paths,
            rg_opts,
            config_args,
            RG,
            DELTA,
            RIPGREP_CONFIG_PATH,
            IMPLICIT_OPTS,
        )
    elif mode == "pattern":
        fzf_cmd = build_pattern_mode_fzf(
            pattern, paths, rg_opts, config_args, RG, DELTA, RIPGREP_CONFIG_PATH
        )
    else:
        sys.exit(1)

    # Run fzf with empty input
    # Need to pipe echo "" | fzf, so we'll use subprocess but with shell=True
    # to preserve the exact bash behavior
    fzf_cmd_str = " ".join(shlex.quote(arg) for arg in fzf_cmd)
    full_cmd = f'echo "" | {fzf_cmd_str}'
    sys.exit(subprocess.call(full_cmd, shell=True))


# ============================================================================
# Helper Functions
# ============================================================================


def parse_arguments(argv):
    """Parse command line arguments for rgi.

    Returns:
        tuple: (mode, pattern, paths, rg_opts)
            - mode: "command" or "pattern"
            - pattern: search pattern string
            - paths: list of paths to search
            - rg_opts: ripgrep options string
    """
    pattern = ""
    paths = []
    rg_opts = ""
    mode = "command"  # default mode

    i = 0
    while i < len(argv):
        if argv[i] == "--rgi-command-mode":
            mode = "command"
            i += 1
        elif argv[i] == "--rgi-pattern-mode":
            mode = "pattern"
            i += 1
        elif argv[i].startswith("-"):
            opt = argv[i]
            rg_opts += f" {opt}"
            i += 1
            # Handle options that take arguments
            if opt in ["-g", "--glob", "-t", "--type", "-e", "--regexp"]:
                if i < len(argv):
                    rg_opts += f" '{argv[i]}'"
                    i += 1
        else:
            break

    # Pattern and paths
    if i < len(argv):
        pattern = argv[i]
        i += 1
    while i < len(argv):
        paths.append(argv[i])
        i += 1
    if len(paths) == 0:
        paths = ["."]

    return mode, pattern, paths, rg_opts


def parse_ripgrep_config(config_path):
    """Parse ripgrep configuration file.

    Args:
        config_path: Path to ripgrep config file from RIPGREP_CONFIG_PATH env var

    Returns:
        str: Space-separated string of config arguments, or empty string
    """
    if not config_path or not os.path.isfile(config_path):
        return ""

    config_args = ""
    with open(config_path, "r") as f:
        for line in f:
            # Trim leading/trailing whitespace
            line = line.strip()
            # Skip comments and empty lines
            if not line or line.startswith("#"):
                continue
            # If line doesn't start with -, wrap it in single quotes
            # (config files don't need quotes, but shell commands do)
            if not line.startswith("-"):
                line = f"'{line}'"
            # Add each arg - they need to be properly spaced
            if config_args:
                config_args += f" {line}"
            else:
                config_args = line

    return config_args


def fzf_base():
    """Build base fzf options common to all modes."""
    return [
        "fzf",
        "--layout",
        "reverse",
        "--info",
        "hidden",
        "--prompt",
        " ",
        "--color",
        "light",
        "--ansi",
        "--bind",
        "ctrl-k:kill-line",
        "--bind",
        "alt-right:forward-word",
        "--bind",
        "alt-left:backward-word",
        "--preview-window",
        "up,70%",
    ]


def build_command_mode_fzf(
    pattern, paths, rg_opts, config_args, RG, DELTA, RIPGREP_CONFIG_PATH, IMPLICIT_OPTS
):
    """Build fzf command for command mode.

    Args:
        pattern: Search pattern
        paths: List of paths to search
        rg_opts: Ripgrep options
        config_args: Arguments from config file
        RG: Full ripgrep command with config and implicit opts
        DELTA: Delta command for formatting
        RIPGREP_CONFIG_PATH: Path to ripgrep config file
        IMPLICIT_OPTS: Implicit options like --json

    Returns:
        list: Complete fzf command as list of arguments
    """
    # Command mode - show command WITHOUT config args in query (they're shown in header)
    # This prevents duplication when switching modes
    paths_str = " ".join(paths)
    # Quote pattern for shell safety (shlex.quote handles spaces and special chars)
    quoted_pattern = shlex.quote(pattern) if pattern else ""
    full_command = f"rg{rg_opts} {quoted_pattern} {paths_str}"

    # Show effective command including config in header
    if config_args:
        header = f"Config applied: {config_args}"
    else:
        header = ""

    # Build the complex bind strings
    config_insert = f" {config_args}" if config_args else ""

    # start:reload and change:reload bindings
    reload_cmd = f'cmd={{q}}; if [[ "$cmd" =~ ^rg ]]; then cmd="${{cmd#rg}}"; cmd="rg{config_insert} {IMPLICIT_OPTS}$cmd"; fi; RIPGREP_CONFIG_PATH= eval "$cmd" 2>/dev/null | {DELTA}'

    # tab:execute binding
    ripgrep_env = (
        f'RIPGREP_CONFIG_PATH="{RIPGREP_CONFIG_PATH}"' if RIPGREP_CONFIG_PATH else ""
    )
    tab_execute = f"{ripgrep_env} rgi-switch-mode pattern {{q}}"

    return fzf_base() + [
        "-d:",
        "--query",
        f"{full_command} ",
        "--phony",
        "--bind",
        f"start:reload:{reload_cmd}",
        "--bind",
        "start:backward-delete-char",
        "--bind",
        f"change:reload:{reload_cmd}",
        "--bind",
        f"tab:execute:{tab_execute}",
        "--bind",
        "enter:execute:open-in-editor {1} {2}",
        "--header",
        header,
        "--preview",
        "[[ -n {1} ]] && rgi-preview {1} {2}",
    ]


def build_pattern_mode_fzf(
    pattern, paths, rg_opts, config_args, RG, DELTA, RIPGREP_CONFIG_PATH
):
    """Build fzf command for pattern mode.

    Args:
        pattern: Search pattern
        paths: List of paths to search
        rg_opts: Ripgrep options
        config_args: Arguments from config file
        RG: Full ripgrep command with config and implicit opts
        DELTA: Delta command for formatting
        RIPGREP_CONFIG_PATH: Path to ripgrep config file

    Returns:
        list: Complete fzf command as list of arguments
    """
    # Pattern mode - the query is just the search pattern
    paths_str = " ".join(paths)

    # Quote pattern for display in fzf query (shlex.quote handles spaces and special chars)
    query_pattern = shlex.quote(pattern) if pattern else ""

    # Build the bind strings
    # For start_reload, always quote the pattern for shell safety
    start_reload = f"RIPGREP_CONFIG_PATH= {RG} {shlex.quote(pattern) if pattern else ''} {paths_str} 2>/dev/null | {DELTA}"
    change_reload = f"RIPGREP_CONFIG_PATH= {RG} {{q}} {paths_str} 2>/dev/null | {DELTA}"

    ripgrep_env = (
        f'RIPGREP_CONFIG_PATH="{RIPGREP_CONFIG_PATH}"' if RIPGREP_CONFIG_PATH else ""
    )
    tab_execute = f"{ripgrep_env} rgi-switch-mode command {{q}} {rg_opts} {paths_str} "

    header = f"rg{config_args if config_args else ''}{rg_opts} {{q}} {paths_str}"

    return fzf_base() + [
        "-d:",
        "--query",
        f"{query_pattern} ",
        "--phony",
        "--bind",
        f"start:reload:{start_reload}",
        "--bind",
        "start:backward-delete-char",
        "--bind",
        f"change:reload:{change_reload}",
        "--bind",
        f"tab:execute:{tab_execute}",
        "--bind",
        "enter:execute:open-in-editor {1} {2}",
        "--header",
        header,
        "--preview",
        "[[ -n {1} ]] && rgi-preview {1} {2}",
    ]


if __name__ == "__main__":
    main()
