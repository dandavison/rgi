#!/usr/bin/env python3
from __future__ import annotations

import os
import shlex
import subprocess
import sys
from pathlib import Path
from typing import List, Tuple


def main() -> None:
    """Main entry point for rgi."""
    SCRIPT_PATH: str = str(Path(__file__).resolve())
    SCRIPT_DIR: str = str(Path(SCRIPT_PATH).parent)
    os.environ["PATH"] = f"{SCRIPT_DIR}:{os.environ.get('PATH', '')}"

    mode, pattern, paths, rg_opts = parse_arguments(sys.argv[1:])

    RIPGREP_CONFIG_PATH: str = os.environ.get("RIPGREP_CONFIG_PATH", "")
    config_args: str = parse_ripgrep_config(RIPGREP_CONFIG_PATH)

    IMPLICIT_OPTS: str = "--json"
    config_part: str = f" {config_args}" if config_args else ""
    RG: str = f"rg{config_part}{rg_opts} {IMPLICIT_OPTS}"
    DELTA: str = "delta --grep-output-type classic"

    fzf_cmd: List[str]
    if mode == "command":
        fzf_cmd = build_command_mode_fzf(
            pattern,
            paths,
            rg_opts,
            config_args,
            RG,
            DELTA,
            RIPGREP_CONFIG_PATH,
            IMPLICIT_OPTS,
        )
    elif mode == "pattern":
        fzf_cmd = build_pattern_mode_fzf(
            pattern, paths, rg_opts, config_args, RG, DELTA, RIPGREP_CONFIG_PATH
        )
    else:
        sys.exit(1)

    # Run fzf with empty input
    # Need to pipe echo "" | fzf, so we'll use subprocess but with shell=True
    # to preserve the exact bash behavior
    fzf_cmd_str: str = " ".join(shlex.quote(arg) for arg in fzf_cmd)
    full_cmd: str = f'echo "" | {fzf_cmd_str}'
    sys.exit(subprocess.call(full_cmd, shell=True))


# ============================================================================
# Helper Functions
# ============================================================================


def parse_arguments(argv: List[str]) -> Tuple[str, str, List[str], str]:
    """Parse command line arguments for rgi."""
    pattern: str = ""
    paths: List[str] = []
    rg_opts: str = ""
    mode: str = "command"

    i: int = 0
    while i < len(argv):
        if argv[i] == "--rgi-command-mode":
            mode = "command"
            i += 1
        elif argv[i] == "--rgi-pattern-mode":
            mode = "pattern"
            i += 1
        elif argv[i].startswith("-"):
            opt = argv[i]
            rg_opts += f" {opt}"
            i += 1
            if opt in ["-g", "--glob", "-t", "--type", "-e", "--regexp"]:
                if i < len(argv):
                    rg_opts += f" '{argv[i]}'"
                    i += 1
        else:
            break

    if i < len(argv):
        pattern = argv[i]
        i += 1
    while i < len(argv):
        paths.append(argv[i])
        i += 1

    return mode, pattern, paths, rg_opts


def parse_ripgrep_config(config_path: str) -> str:
    """Parse ripgrep config file and return as command line args string."""
    if not config_path or not os.path.isfile(config_path):
        return ""

    config_args = []
    with open(config_path, "r") as f:
        for line in f:
            line = line.strip()
            if not line or line.startswith("#"):
                continue
            if not line.startswith("-"):
                line = f"'{line}'"
            config_args.append(line)

    return " ".join(config_args)


def fzf_base() -> List[str]:
    """Base fzf options common to all modes."""
    return [
        "fzf",
        "--layout",
        "reverse",
        "--info",
        "hidden",
        "--prompt",
        " ",
        "--color",
        "light",
        "--ansi",
        "--bind",
        "ctrl-k:kill-line",
        "--bind",
        "alt-right:forward-word",
        "--bind",
        "alt-left:backward-word",
        "--preview-window",
        "up,70%",
    ]


def build_command_mode_fzf(
    pattern: str,
    paths: List[str],
    rg_opts: str,
    config_args: str,
    RG: str,
    DELTA: str,
    RIPGREP_CONFIG_PATH: str,
    IMPLICIT_OPTS: str,
) -> List[str]:
    """Build fzf command for command mode."""
    paths_str: str = " ".join(paths)
    quoted_pattern: str = shlex.quote(pattern) if pattern else ""
    full_command: str = f"rg{rg_opts} {quoted_pattern} {paths_str}"

    header = f"Config applied: {config_args}" if config_args else ""

    config_insert = f" {config_args}" if config_args else ""
    reload_cmd = (
        f"cmd={{q}}; "
        f'if [[ "$cmd" =~ ^rg ]]; then '
        f'cmd="${{cmd#rg}}"; '
        f'cmd="rg{config_insert} {IMPLICIT_OPTS}$cmd"; '
        f"fi; "
        f'RIPGREP_CONFIG_PATH= eval "$cmd" 2>/dev/null | {DELTA}'
    )

    env_prefix = (
        f'RIPGREP_CONFIG_PATH="{RIPGREP_CONFIG_PATH}"' if RIPGREP_CONFIG_PATH else ""
    )
    tab_execute = f"{env_prefix} rgi-switch-mode pattern {{q}}"

    return fzf_base() + [
        "-d:",
        "--query",
        f"{full_command} ",
        "--phony",
        "--bind",
        f"start:reload:{reload_cmd}",
        "--bind",
        "start:backward-delete-char",
        "--bind",
        f"change:reload:{reload_cmd}",
        "--bind",
        f"tab:execute:{tab_execute}",
        "--bind",
        "enter:execute:open-in-editor {1} {2}",
        "--header",
        header,
        "--preview",
        "[[ -n {1} ]] && rgi-preview {1} {2}",
    ]


def build_pattern_mode_fzf(
    pattern: str,
    paths: List[str],
    rg_opts: str,
    config_args: str,
    RG: str,
    DELTA: str,
    RIPGREP_CONFIG_PATH: str,
) -> List[str]:
    """Build fzf command for pattern mode."""
    paths_str: str = " ".join(paths)
    quoted_pattern: str = shlex.quote(pattern) if pattern else ""

    start_reload = (
        f"RIPGREP_CONFIG_PATH= {RG} {quoted_pattern} {paths_str} 2>/dev/null | {DELTA}"
    )
    change_reload = f"RIPGREP_CONFIG_PATH= {RG} {{q}} {paths_str} 2>/dev/null | {DELTA}"

    env_prefix = (
        f'RIPGREP_CONFIG_PATH="{RIPGREP_CONFIG_PATH}"' if RIPGREP_CONFIG_PATH else ""
    )
    tab_execute = f"{env_prefix} rgi-switch-mode command {{q}} {rg_opts} {paths_str} "

    header: str = f"rg{config_args if config_args else ''}{rg_opts} {{q}} {paths_str}"

    return fzf_base() + [
        "-d:",
        "--query",
        f"{quoted_pattern} ",
        "--phony",
        "--bind",
        f"start:reload:{start_reload}",
        "--bind",
        "start:backward-delete-char",
        "--bind",
        f"change:reload:{change_reload}",
        "--bind",
        f"tab:execute:{tab_execute}",
        "--bind",
        "enter:execute:open-in-editor {1} {2}",
        "--header",
        header,
        "--preview",
        "[[ -n {1} ]] && rgi-preview {1} {2}",
    ]


if __name__ == "__main__":
    main()
